version: "3.8"

services:
  qwen:
    image: vllm/vllm-openai:latest
    container_name: qwen
    restart: unless-stopped
    ipc: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ '0' ]
              capabilities: [gpu]
    volumes:
      - /home/models/Qwen2.5-7B-Instruct:/models/Qwen2.5-7B-Instruct:ro
    command: >
      --model /models/Qwen2.5-7B-Instruct
      --port 8001
      --host 0.0.0.0
      --gpu-memory-utilization 0.75
      --max-model-len 32768
      --dtype bfloat16
    networks:
      - ai-net

  whisper:
    image: ai-deploy_whisper:latest
    container_name: whisper
    restart: unless-stopped
    ipc: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ '1' ]
              capabilities: [gpu]
    volumes:
      - /home/models/faster-whisper-large-v3:/app/models/faster-whisper-large-v3:ro
      - /home/ManMi/ai-services/whisper:/app/code
    working_dir: /app/code
    command: python3 model_whisper.py --port 8002 --host 0.0.0.0
    networks:
      - ai-net

  chattts:
    image: ai-deploy-chattts:latest
    container_name: chattts
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ '1' ]
              capabilities: [gpu]
    volumes:
      - /home/models/ChatTTS:/models/ChatTTS:ro
      - /home/ManMi/ai-services:/app/ai-services:ro
      # 如果还有其他必须挂载的目录，在这里继续加
    command: python3 /app/ai-services/chattts/model_chattts.py --port 8003 --host 0.0.0.0
    networks:
      - ai-net

  nginx:
    image: nginx:1.25
    container_name: nginx-gateway
    restart: unless-stopped
    ports:
      - "9007:9007"
    volumes:
      - /home/ManMi/ai-deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - qwen
      - whisper
      - chattts
    networks:
      - ai-net

networks:
  ai-net:
    driver: bridge