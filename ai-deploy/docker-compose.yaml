version: "3.8"

services:
  qwen:
    image: vllm/vllm-openai:latest
    container_name: qwen
    restart: unless-stopped
    ipc: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - /home/models/Qwen2.5-7B-Instruct:/models/Qwen2.5-7B-Instruct:ro
    command: >
      --model /models/Qwen2.5-7B-Instruct
      --port 8000
      --host 0.0.0.0
      --gpu-memory-utilization 0.8
      --max-model-len 32768
      --dtype bfloat16
    networks:
      - ai-net
    # 重要：不要映射 ports！让它只在内网监听

  chattts:
    image: ai-deploy_chattts:latest
    container_name: chattts
    restart: unless-stopped
    ipc: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - /home/models/ChatTTS:/app/models/ChatTTS:ro
      - /home/ManMi/ai-services/chattts:/app/code
    working_dir: /app/code
    command: python model_chattts.py --port 8001 --host 0.0.0.0   # ← 必须指定 --port 8001
    networks:
      - ai-net
    # 不要映射 ports

  whisper:
    image: ai-deploy_whisper:latest
    container_name: whisper
    restart: unless-stopped
    ipc: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - /home/models/faster-whisper-large-v3:/app/models/whisper:ro
      - /home/ManMi/ai-services/whisper:/app/code
    working_dir: /app/code
    command: python model_whisper.py --port 8002 --host 0.0.0.0   # ← 必须指定 --port 8002
    networks:
      - ai-net
    # 不要映射 ports

  nginx:
    image: nginx:1.25
    container_name: nginx-gateway
    restart: unless-stopped
    ports:
      - "9007:9007"               # 只暴露这一个端口
    volumes:
      - /home/ManMi/ai-deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - qwen
      - chattts
      - whisper
    networks:
      - ai-net

networks:
  ai-net:
    driver: bridge